# 波形生成用割り込み
## 矩形波
クロック = 16MHz

8分周し、
16MHz / 8 = 2MHz
でカウントアップ

カウントが
REGISTER::freqency << 2 
に達した時割り込み発生

波形の時間軸方向の分解能は 矩形波の場合 8 = 2^3 であるから、再生される周波数 f は
 
 ```
 f = 16MHz / 8 / ((2^11 - REGISTER::frequency) << 1) / 8
   = 125,000 Hz / (2048 - REGISTER::freqency)

 f_max = 125,000Hz
 f_min = 61Hz
```

となる。

波形メモリの場合、時間軸方向の分解能が 16 = 2^4 であるため、矩形波の周波数に比して半分の周波数となる。

### GB音源
参考までに、GB音源の場合

クロック = 4194304Hz

```
f = 4194304 / 32 / (2048 - REGISTER::frequency)
  = 131072 / (2048 - REGISTER::frequency)
```

と、若干計算式が違うため、音色もまた若干違いが生じるものと考えられる。

## 波形メモリ
波形の時間軸方向の分解能は 波形メモリの場合 32 = 2^5 であるから、再生される周波数 f は
 
 ```
 f = 16MHz / 8 / (2^11 - REGISTER::frequency) / 32
   = 62,500 Hz / (2048 - REGISTER::freqency)

 f_max = 62,500Hz
 f_min = 30Hz
```

# エンベロープ制御用割り込み
```
 (1,048,576 / (r+1)) >> (s+1)
 = 1,000,000 / (r + 1) / (2^s) / 2
 = 500,000 / ((r + 1) << s)
```

s < 8 の時  
分周比:8
```
16,000,000 / 8 / ((r + 1) << s)

500,000 / ((r + 1) << s)
= 2,000,000 / ((r + 1) << (s + 2))
```

s => 8 の時  
分周比:64
```
16,000,000 / 64 / ((r + 1) << s)

500,000 . ((r + 1) << s)
250,000 / ((r + 1) << (s - 1))
```


[参考リンク](https://dic.nicovideo.jp/a/gb%E9%9F%B3%E6%BA%90)

> //レジスタの初期値   
> reg = 0xffff;  
> output = 1;  
> //以下の2行を回す。  
> //　shortFreqは、短周期フラグ。1にすると有効になる。  
> //　これで得られるoutputの値が、ノイズチャンネルの波形。  
> if(reg == 0)reg = 1; //一応  
> reg += reg + (((reg >> (shortFreq ? 6 : 14)) ^ (reg >> (shortFreq ? 5 : 13))) & 1);  
>  output ^= reg & 1;
